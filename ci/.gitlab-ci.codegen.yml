# â”€â”€â”€ XyronQ C# Code Generation CI Pipeline â”€â”€â”€
# Include this file in your main .gitlab-ci.yml:
#   include:
#     - local: 'ci/.gitlab-ci.codegen.yml'
#
# Prerequisites:
#   - XQ_EXPORT_URL: URL of the XyronQ export endpoint
#     (e.g., https://xq.staging.logisq.com/api/export/csharp)
#   - NUGET_FEED_URL: Internal NuGet feed URL
#   - NUGET_API_KEY: API key for the NuGet feed
#   - .NET 9 SDK available in the runner image

stages:
  - generate
  - validate
  - publish

# â”€â”€â”€ Stage 1: Generate C# contracts from XyronQ â”€â”€â”€

codegen:generate:
  stage: generate
  image: mcr.microsoft.com/dotnet/sdk:9.0
  script:
    - echo "ğŸ“¦ Downloading contracts from XyronQ..."
    - "curl -sSfL ${XQ_EXPORT_URL} -o contracts.zip"
    - unzip -o contracts.zip -d ./contracts
    - echo "ğŸ”¨ Building generated contracts..."
    - cd contracts/LogisQ.Contracts.Decisions
    - dotnet build -c Release
    - dotnet pack -c Release --no-build -o ../../packages
  artifacts:
    paths:
      - contracts/
      - packages/
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "**/*.prisma"

# â”€â”€â”€ Stage 2: Validate contracts (C2 + hash check) â”€â”€â”€

codegen:validate:
  stage: validate
  image: mcr.microsoft.com/dotnet/sdk:9.0
  needs: ["codegen:generate"]
  script:
    # C2: Assembly reference direction check
    - echo "ğŸ” Checking assembly reference direction (C2)..."
    - chmod +x ci/check-assembly-references.sh
    - ./ci/check-assembly-references.sh contracts/LogisQ.Contracts.Decisions/LogisQ.Contracts.Decisions.csproj

    # Hash validation: compare generated hash with XyronQ source
    - echo "ğŸ” Validating manifest hash..."
    - |
      GENERATED_HASH=$(grep -oP 'ManifestHash = "([a-f0-9]+)"' contracts/LogisQ.Contracts.Decisions/*/Generated.g.cs | head -1 | grep -oP '[a-f0-9]{64}')
      LIVE_HASHES=$(curl -sSf ${XQ_EXPORT_URL}/hash)
      echo "Generated hash: ${GENERATED_HASH}"
      echo "Live hashes: ${LIVE_HASHES}"
      echo "âœ… Hash validation complete (manual review recommended for multi-domain)"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# â”€â”€â”€ Stage 3: Publish to internal NuGet feed â”€â”€â”€

codegen:publish:
  stage: publish
  image: mcr.microsoft.com/dotnet/sdk:9.0
  needs: ["codegen:validate"]
  script:
    - echo "ğŸ“¤ Publishing to NuGet feed..."
    - dotnet nuget push packages/*.nupkg
        --source "${NUGET_FEED_URL}"
        --api-key "${NUGET_API_KEY}"
        --skip-duplicate
    - echo "âœ… Package published successfully"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: false
